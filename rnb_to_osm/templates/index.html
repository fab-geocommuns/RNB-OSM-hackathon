<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RNB to OSM</title>
    <style>
        body {
            font-family: "Open Sans", sans-serif;
            font-size: 14px;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #fefefe;
        }

        .container {
            background-color: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .centered {
            text-align: center;
        }

        h1 {
            color: #333;
        }

        .info {
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
        }

        .info img {
            max-height: 150px;
        }

        .export-section {
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: 5px;
            margin: 20px 0;
            border-left: 4px solid #007bff;
        }

        .button {
            background-color: #007bff;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            text-decoration: none;
            height: 40px;
        }

        select {
            height: 40px;
            border-radius: 4px;
            padding: 0 10px;
            font-size: 16px;
            margin-right: 10px;
        }

        .button:hover {
            background-color: #0056b3;
        }

        .button:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }

        #status {
            margin-top: 15px;
            padding: 10px;
            border-radius: 4px;
            display: none;
        }

        .status-success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status-error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .status-pending {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
    </style>
</head>

<body>
    <div class="info centered">
        <img src="{{ url_for('static', filename='RNB-to-OSM.svg') }}" alt="RNB to OSM" />
        <h1>RNB to OSM</h1>
        <p>Identifiez les b√¢timents √† am√©liorer dans OSM gr√¢ce aux donn√©es du
            <a href="https://rnb.beta.gouv.fr/" target="_blank">
                R√©f√©rentiel National du B√¢timent (RNB)
            </a>.
        </p>
        <br />
        <p><a class="button" href="https://rnb.beta.gouv.fr/carte" target="_blank">Voir la carte du RNB</a>
        </p>
        
    </div>
    <div class="export-section">
        <h1>
            <span><span class="emoticon">üì§</span></span>&nbsp;Exporter les donn√©es
        </h1>
        <p>G√©n√©rez un fichier .osm (√† ouvrir directement dans JOSM) contenant uniquement les b√¢timents OSM
            (r√©cup√©r√©s depuis overpass) sur lesquels les tags RNB sont rajout√©s.</p>
        <blockquote>
            <p><span data-emoticon="exclamation"><span class="emoticon">‚ùó</span></span>Attention : l'int√©gration des ID
                RNB doit se faire apr√®s un travail minutieux de v√©rification manuelle. Si vous n'√™tes pas s√ªr de vous,
                n'h√©sitez pas √† demander de l'aide <a
                    href="https://forum.openstreetmap.fr/" rel="noreferrer" target="_blank">sur le forum</a>.</p>
        </blockquote>
        <p>S√©lectionnez un d√©partement et une ville pour exporter les donn√©es:</p>

        <select placeholder="D√©partement" id="departmentSelect" style="min-width: 100px;">
        </select>
        <select placeholder="Ville" id="citySelect" style="min-width: 250px;">
        </select>
        <button id="exportBtn" class="button" onclick="triggerExport()">Exporter</button>
        <div id="status"></div>
        <p><span></span><span>üöß</span></span> N.B. 10 juin 2025 : ce service d'export de donn√©es est en b√™ta-test. Vos
            propositions d'am√©liorations sont les bienvenues <a
                href="https://forum.openstreetmap.fr/" rel="noreferrer" target="_blank">sur le forum</a>.</p>
    </div>
    <div class="info">
        <h1>
            <span data-emoticon="information_source"><span>‚ÑπÔ∏è</span></span>&nbsp;Documentation
        </h1>
        <p>Ces donn√©es sont le r√©sultat d‚Äôune analyse comparative calculant automatiquement un taux de confiance : c'est
            le pourcentage de recouvrement des surfaces des b√¢timents entre le r√©f√©rentiel du RNB et OSM. Seules les
            donn√©es consid√©r√©es comme les plus fiables sont export√©es : celles dont le taux de confiance est &gt;70%.
        </p>
        <p><em>Le d√©tail de ce calcul est publi√© √† l‚Äôadresse <a
                    href="https://github.com/fab-geocommuns/RNB-OSM-hackathon" rel="noreferrer" target="_blank">GitHub -
                    fab-geocommuns/RNB-OSM-hackathon: Hackathon pour rapprocher les ID-RNBs de OSM</a></em></p>
        <ul class="markdown__list">
            <li>
                <span>D√©finition d‚Äôun b√¢timent dans OSM sur laquelle se base les donn√©es :&nbsp;<a
                       
                        href="https://wiki.openstreetmap.org/wiki/FR:Key:ref:FR:RNB#D%C3%A9finition_d'un_b%C3%A2timent_dans_OSM"
                        rel="noreferrer" target="_blank">FR<span data-emoticon="key"><span>:Key:</span></span>ref<span
                            data-emoticon="fr"><span>:FR:</span></span>RNB ‚Äî OpenStreetMap Wiki</a></span>
            </li>
            <li>
                <span>D√©finition d‚Äôun b√¢timent dans le RNB :&nbsp;<a
                        href="https://rnb.beta.gouv.fr/definition" rel="noreferrer" target="_blank">R√©f√©rentiel National
                        des B√¢timents</a></span>
            </li>
        </ul>
        <h1><span data-emoticon="hammer_and_wrench"><span>üõ†Ô∏è</span></span>&nbsp;Exploitation
            des donn√©es</h1>
        <ul class="markdown__list">
            <li><span>Le tag&nbsp;<span class="codespan__pre-wrap"><code>ref:FR:RNB</code></span>&nbsp;est ajout√© aux
                    b√¢timents r√©cup√©r√©s d'OSM. Il contient un ou plusieurs identifiant(s) RNB sugg√©r√©(s) √† l‚Äôint√©gration
                    dans OpenStreetMap. Il est possible de disposer de valeurs multiples, s√©par√©es par des&nbsp;<span
                        class="codespan__pre-wrap"><code>;</code></span>&nbsp;pour un seul b√¢timent OSM. L‚Äôidentifiant
                    RnB est p√©renne pour chaque b√¢timent.</span></li>
        </ul>
        <p><em>N.B. : si un b√¢timent est d√©truit et un nouveau est reconstruit au m√™me emplacement, alors un nouvel ID
                est cr√©√© dans le RNB ; l‚Äôancien ID continue d‚Äôexister mais prend le statut ‚Äúd√©truit‚Äù. Cette information
                ne fait pas partie de l'export : elle est √† retrouver dans les donn√©es du RNB.</em></p>
        <ul class="markdown__list">
            <li><span>Le tag&nbsp;<span class="codespan__pre-wrap"><code>diff:ref:FR:RNB</code></span>&nbsp;: pr√©cision
                    √©ventuelle de diff√©rence de mod√©lisation entre les donn√©es RNB et OSM. Il prend la valeur&nbsp;<span
                        class="codespan__pre-wrap"><code>splited</code></span>&nbsp;si un b√¢timent RNB correspond √†
                    plusieurs b√¢timents OSM, il prend la valeur&nbsp;<span
                        class="codespan__pre-wrap"><code>multiple</code></span>&nbsp;si plusieurs b√¢timents RNB
                    correspondent √† un seul b√¢timent OSM.</span></li>
        </ul>
        <p><em>Par exemple, les deux b√¢timents identifi√©s sous les r√©f√©rences <span
                    class="codespan__pre-wrap"><code>S3HFGTCH14VF;C5NW96R48RQE</code></span> dans le RNB correspond dans
                OSM √† un seul b√¢timent <a
                    href="https://www.openstreetmap.org/way/190591890" rel="noreferrer"
                    target="_blank">https://www.openstreetmap.org/way/190591890</a> avec le tag <span
                    class="codespan__pre-wrap"><code>diff:ref:FR:RNB=multiple</code></span>.</em></p>
        <hr />
        <p>Code source de ce site : <a
                href="https://github.com/fab-geocommuns/RNB-OSM-hackathon" rel="noreferrer"
                target="_blank">https://github.com/fab-geocommuns/RNB-OSM-hackathon</a> </p>
    
    </div>

    <script>
        const departmentSelect = document.getElementById('departmentSelect');
        const citySelect = document.getElementById('citySelect');

        const cities = {{ cities | tojson }};
        const departmentsToCities = {};
        cities.forEach(city => {
            const department = city.code_insee.slice(0, 2);
            if (!departmentsToCities[department]) {
                departmentsToCities[department] = [];
            }
            departmentsToCities[department].push(city);
        });
        const departments = Object.keys(departmentsToCities).sort();
        departments.forEach(department => {
            const option = document.createElement('option');
            option.value = department;
            option.textContent = department;
            departmentSelect.appendChild(option);
        });
        departmentSelect.value = '00';
        citySelect.value = '00000';

        departmentSelect.addEventListener('change', () => {
            const department = departmentSelect.value;
            const cities = departmentsToCities[department];
            citySelect.innerHTML = '';
            cities.forEach(city => {
                const option = document.createElement('option');
                option.value = city.code_insee;
                option.textContent = city.label;
                citySelect.appendChild(option);
            });
        });
    </script>

    <script>
        let currentExportId = null;
        let statusInterval = null;

        async function triggerExport() {
            const citySelect = document.getElementById('citySelect');
            const codeInsee = citySelect.value;
            const btn = document.getElementById('exportBtn');
            const status = document.getElementById('status');

            btn.disabled = true;
            btn.textContent = 'En cours...';
            hideStatus();

            try {
                const response = await fetch('/export', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ code_insee: codeInsee })
                });

                const data = await response.json();

                if (response.ok) {
                    currentExportId = data.export_id;
                    pollStatus();
                } else {
                    console.error(data);
                    showStatus(`Error: ${data.message}`, 'error');
                    resetButton();
                }

            } catch (error) {
                showStatus(`Error: ${error.message}`, 'error');
                resetButton();
            }
        }

        async function pollStatus() {
            const response = await fetch(`/export/${currentExportId}`);
            const data = await response.json();
            if (data.status === 'finished') {
                downloadFile(data.result);
                resetButton();
                return;
            }

            if (data.status === 'failed') {
                showStatus(`Error: ${data.message}`, 'error');
                resetButton();
                return;
            }

            setTimeout(pollStatus, 5000);
        }


        function resetButton() {
            const btn = document.getElementById('exportBtn');
            btn.disabled = false;
            btn.textContent = 'Exporter';
        }

        function downloadFile(content) {
            const blob = new Blob([content], { type: 'application/xml' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'export.osm';
            a.click();
        }

        function hideStatus() {
            const status = document.getElementById('status');
            status.style.display = 'none';
        }

        function showStatus(message, type) {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = `status-${type}`;
            status.style.display = 'block';
        }
    </script>
</body>

</html>